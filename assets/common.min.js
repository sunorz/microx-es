function rotateImage(e){const t=e.querySelector("img");t.src="../images/load2.svg"}function stopAnimation(){if(animationId&&(clearTimeout(animationId),animationId=null),minLoadTimer&&(clearTimeout(minLoadTimer),minLoadTimer=null),currentAudio&&currentAudio._onReady&&(currentAudio.removeEventListener("canplay",currentAudio._onReady),delete currentAudio._onReady),currentPlayer){const e=currentPlayer.querySelector(".bars"),t=currentPlayer.querySelector(".play-icon");e.style.display="none",t.style.display="block",t.innerHTML='<svg viewBox="0 0 100 100" width="60" height="60" xmlns="http://www.w3.org/2000/svg">\n                <path class="playsvg" d=" M 20 15 Q 20 10 25 13 L 85 48 Q 90 50 85 52 L 25 87 Q 20 90 20 85 Z"/></svg>';const o=e.querySelectorAll(".bar");o.forEach(e=>e.style.height="30px"),currentAudio&&(currentAudio.pause(),currentAudio.currentTime=0),currentPlayer=null,currentAudio=null}}function startRandomAnimation(e,t,o){function n(){t.forEach(e=>{const t=Math.floor(20*Math.random())+5;e.style.height=`${t}px`}),animationId=setTimeout(n,200)}e.style.display="flex",o.style.display="none",n()}function calculateY(e){const t=new Date(Date.UTC(2025,4,1,16,0,0)),o=new Date(e+"T00:00:00+08:00"),n=Math.floor((o-t)/864e5);if(n<0)return 0;const r=10,s=.5,i=465,l=9455,a=(83621-r*i-s*l)/31,d=n,c=(d+1)*a+r*(d*(d+1))/2+s*(d*(d+1)*(2*d+1))/6;return Math.floor(c)}function formatFollowers(e){return e<1e3?e:e<1e6?`${(e/1e3).toFixed(1)}K`:e<1e9?`${(e/1e6).toFixed(1)}M`:`${(e/1e9).toFixed(2)}B`}document.addEventListener("DOMContentLoaded",function(){let e=!0;const t=["jpg","jpeg","png","gif","webp","avif"],o=["mp4","mov","webm","m3u8"];document.querySelectorAll(".loading").forEach(n=>{"IMG"!==n.tagName&&"VIDEO"!==n.tagName||n.removeAttribute("src"),n.addEventListener("click",async function(){async function n(e){try{const t=new AbortController,o=setTimeout(()=>t.abort(),1e4),n=await fetch(e,{method:"HEAD",credentials:"include",signal:t.signal});return clearTimeout(o),n.status}catch(e){return"AbortError"===e.name?-1:0}}function r(e,t){if(!t)return;const o=e.match(/^([^-]+)-/);if(!o)return;const n=o[1],r=`../images/private/${n}.md`;fetch(r,{method:"HEAD"}).then(e=>{if(e.ok)return fetch(r,{credentials:"include"}).then(e=>e.text()).then(e=>{const t=document.createElement("div");t.className="media-c",t.innerHTML=e,l.appendChild(t)})})}if(this.classList.contains("loading-in-progress"))return;const s=this.getAttribute("data-media"),i=this.getAttribute("data-copyright");if(!s||0===s.length)return void setTimeout(()=>{this.classList.remove("loading-in-progress"),this.classList.remove("loading"),this.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>';let e=this.querySelector(".load-insert");e.style.setProperty("--load-text",'"Error 500"')},5e3);if(!this.classList.contains("loading"))return;i&&"off"===i&&(e=!1),this.classList.add("loading-in-progress");const l=this,a=s.split(",").map(e=>e.trim()).filter(e=>e);if(1===a.length){const m=a[0],u=m.split(".").pop().toLowerCase(),g=`../images/private/${m}`,y=`/wsfile.html?file=${m}`;if(o.includes(u)){const p=await n(y);if(200!=p){l.innerHTML='\n        <div class="load-insert load-msg">\n            <img class="load-icon" src="../images/error.svg">\n        </div>\n    ',l.classList.remove("loading-in-progress","loading"),l.classList.add("error-state");const f=l.querySelector(".load-insert");return void(f&&f.style.setProperty("--load-text",`"Error ${p}"`))}const v=document.createElement("video");v.className="tweet-video video-js vjs-default-skin",v.controls=!0,v.preload="metadata",v.style.pointerEvents="auto",v.style.display="none";const h=m.toLowerCase().endsWith(".m3u8");if(h){l.appendChild(v);const L=videojs(v,{techOrder:["html5"],sources:[{src:y,type:"application/x-mpegURL"}],controlBar:{pictureInPictureToggle:!1},errorDisplay:!1});L.ready(()=>{r(m,e);const t=()=>{const e=L.el().querySelector("video");let t=e.videoWidth||300,o=e.videoHeight||300;(t<=0||o<=0)&&(t=300,o=300);const n=300,r=300,s=t/o;let i,a;s>1?(i=n,a=n/s):(a=r,i=r*s);const d=L.el();d.style.width=`${i}px`,d.style.height=`${a}px`,d.style.minWidth="100px",e.style.width="100%",e.style.height="100%",l.classList.remove("loading-in-progress"),l.classList.remove("loading");const c=l.querySelector(".load-insert"),m=l.querySelectorAll("video, div");m.forEach(e=>{"none"===e.style.display&&(e.style.display="",c.remove())})},o=L.el().querySelector("video");o.addEventListener("loadedmetadata",t),setTimeout(t,3e3),o.addEventListener("loadeddata",t)}),L.on("error",()=>{window.capturedHttpStatus?d({status:window.capturedHttpStatus}):d({status:null})})}else v.src=y,l.innerHTML="",l.appendChild(v),v.onloadeddata=()=>{l.classList.remove("loading-in-progress"),l.classList.remove("loading"),r(m,e)};function d(e){const t=l.querySelector(".video-js");t&&t.parentNode.removeChild(t),window.player&&window.player.dispose&&(window.player.dispose(),window.player=null);const o={401:"401",403:"403",404:"404",415:"415",500:"500"};let n,r=e.status;r||(4===e.code?r=415:2===e.code&&(r=404)),n=r?o[r]||`Error ${r}`:"网络连接异常：无法加载视频",l.innerHTML='\n        <div class="load-insert load-msg">\n            <img class="load-icon" src="../images/error.svg">\n        </div>\n    ',l.classList.remove("loading-in-progress","loading"),l.classList.add("error-state");const s=l.querySelector(".load-insert");s&&s.style.setProperty("--load-text",`"${n.replace(/"/g,'\\"')}"`)}}else fetch(g,{credentials:"include",headers:{"Cache-Control":"no-cache"}}).then(o=>{if(!o.ok){l.classList.remove("loading-in-progress"),l.classList.remove("loading"),l.innerHTML='<div class="load-insert"><img class="load-icon" src="../images/error.svg"></div>';let e=l.querySelector(".load-insert");throw e.style.setProperty("--load-text",`"Error ${o.status}"`),new Error(`${o.status}`)}if(!t.includes(u)){l.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>',l.classList.remove("loading-in-progress"),l.classList.remove("loading");let e=l.querySelector(".load-insert");throw e.style.setProperty("--load-text",'"Error 500"'),new Error("500")}{const t=new Image;t.src=g,t.className="tweet-image",t.onload=()=>{l.innerHTML="",l.appendChild(t),r(m,e),l.classList.remove("loading-in-progress"),l.classList.remove("loading")},t.onerror=()=>{l.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>',l.classList.remove("loading-in-progress"),l.classList.remove("loading");let e=l.querySelector(".load-insert");e.style.setProperty("--load-text",'"Error 404"')}}}).catch(e=>{l.classList.remove("loading-in-progress"),l.classList.remove("loading"),l.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>';let t=l.querySelector(".load-insert");t.style.setProperty("--load-text",`"Error ${e.message}"`)})}else if(a.length>1){const w=a.every(e=>{const o=e.split(".").pop().toLowerCase();return t.includes(o)});if(!w){l.classList.remove("loading-in-progress"),l.classList.remove("loading"),l.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>';let S=l.querySelector(".load-insert");return void S.style.setProperty("--load-text",'"Error 500"')}const E=document.createElement("div");E.className="multi-image-container";let x=a.length,b=0;function c(){if(b===x){l.classList.remove("loading-in-progress"),l.classList.remove("loading"),l.innerHTML="";const t=E.children.length;if(t>0)l.appendChild(E),a.length>0&&r(a[0],e);else{l.innerHTML='<div class="load-insert load-msg"><img class="load-icon" src="../images/error.svg"></div>';let e=l.querySelector(".load-insert");e.style.setProperty("--load-text",'"Error 404"')}}}a.forEach(e=>{const t=`../images/private/${e}`,o=new Image;o.src=t,o.className="tweet-image",o.onload=()=>{E.appendChild(o),b++,c()},o.onerror=()=>{b++,c()}})}})});const n=document.querySelectorAll(".trans-button");n.forEach(e=>{e.addEventListener("click",()=>{const t=e.nextElementSibling;document.querySelectorAll(".tweet-text.trans").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".trans-button").forEach(e=>{e.style.display="block"}),t.style.display="block",e.style.display="none"})});const r=document.querySelectorAll(".tweet").length,s=document.getElementById("tposts");s?s.textContent=r.toString():console.error("未找到id为tposts的元素")});const lazyImages=document.querySelectorAll(".lazyload"),observer=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const o=e.target,n=o.dataset.src;fetch(n).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e);o.src=t,o.onload=()=>{URL.revokeObjectURL(t),o.classList.remove("lazyload")}}).catch(e=>{console.error("Error loading image:",e)}),t.unobserve(o)}})});lazyImages.forEach(e=>{observer.observe(e)});let currentPlayer=null,currentAudio=null,animationId=null,minLoadTimer=null;document.querySelectorAll(".player").forEach(e=>{const t=e.querySelector(".bars"),o=t.querySelectorAll(".bar"),n=e.querySelector("audio"),r=e.querySelector(".play-icon"),s=n.getAttribute("data-media");e.addEventListener("click",()=>{const i=currentPlayer===e;if(i)stopAnimation();else{stopAnimation(),currentPlayer=e,currentAudio=n,r.innerHTML='<img class="load-audio-icon" src="../images/load2.svg">';let a=!1,d=!1;const c=()=>{a=!0,l()};function l(){if(a&&d){const e=n.play();void 0!==e?e.then(()=>{startRandomAnimation(t,o,r)}).catch(e=>{console.warn("音频播放被阻止或出错",e)}):startRandomAnimation(t,o,r)}}n._onReady=c,n.addEventListener("canplay",c,{once:!0}),minLoadTimer=setTimeout(()=>{d=!0,l()},5e3),n.src=s,n.load()}}),n.addEventListener("ended",()=>{stopAnimation()})}),document.addEventListener("click",async function(e){const t=e.target.closest(".more-options");if(!t)return;const o=t.closest(".tweet");if(!o)return;const n=o.dataset.tweetId||"",r=o.querySelector(".tweet-text")?.innerHTML||"",s=o.querySelector(".tweet-text.trans")?.innerHTML||"",i=document.getElementById("capture-area");i.innerHTML=`\n        <div style="\n            max-width: 500px;\n            width:100%;\n            min-height: 100px;\n            padding: 14px;\n            background-color:var(--md-background);\n            color: var(--md-on-background);\n            font-family: 'Noto Serif SC', 'Georgia', 'Times New Roman', serif;\n        ">\n            <div id="original-text" style="font-size: 12px;padding:8px;line-height:2;text-indent:2em;">${r}</div>\n            <div style="font-size: 12px;padding:8px;line-height:2;">${s}</div>\n            <div style="\n    font-size: 5%; /* 父容器宽度的百分比 */\n    padding:0.5rem;\n    text-align:center;\n    position:absolute;\n    top:50%;\n    left:50%;\n    transform: translate(-50%, -50%) rotate(-30deg);\n    border:5px solid #f28b82; /* 相对缩放 */\n    color:#f28b82;\n    z-index:-1;\n    white-space: nowrap;\n">\n    高级不可回收物\n</div>\n        </div>\n    `;const l=i.querySelector("#original-text");if(l){const e=l.innerText.trim(),t=window.getComputedStyle(l),o=parseFloat(t.fontSize),n=l.clientWidth,r=Math.floor(n/o);e.length<=r&&(l.style.textIndent="0")}const a=await html2canvas(i.querySelector("div")),d=a.toDataURL("image/png"),c=document.getElementById("preview-modal"),m=document.getElementById("preview-image-container"),u=document.getElementById("download-btn"),g=document.querySelector(".qq-titlebar-button.close");m.innerHTML=`<img src="${d}" style="width: 100%;display:block;" />`,m.style.backgroundPosition="center",c.style.display="flex",document.body.style.overflow="hidden",document.getElementById("preview-modal").style.display="flex",u.onclick=()=>{const e=document.createElement("a");e.download=`tweet${n}.png`,e.href=d,e.click(),document.body.style.overflow="",document.getElementById("preview-modal").style.display="none"},g.onclick=()=>{document.body.style.overflow="",document.getElementById("preview-modal").style.display="none"}});